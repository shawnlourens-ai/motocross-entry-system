<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Motocross Track Entry</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<!-- ZXing PDF417 Scanner -->
<script src="https://unpkg.com/@zxing/library@latest/umd/index.min.js"></script>

<!-- EmailJS SDK -->
<script src="https://cdn.emailjs.com/sdk/3.2/email.min.js"></script>

<style>
* { box-sizing: border-box; }
body { 
  font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Arial, sans-serif;
  background: linear-gradient(135deg, #ff6b35 0%, #f7931e 100%);
  margin: 0;
  padding: 20px;
  min-height: 100vh;
}

.container {
  max-width: 480px;
  margin: 0 auto;
}

.header {
  background: #fff;
  padding: 20px;
  border-radius: 12px 12px 0 0;
  text-align: center;
  box-shadow: 0 2px 8px rgba(0,0,0,0.1);
}

.header h1 {
  margin: 0;
  color: #333;
  font-size: 24px;
}

.header .subtitle {
  color: #666;
  font-size: 14px;
  margin-top: 5px;
}

.progress {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-top: 20px;
  padding: 0 10px;
}

.progress-step {
  width: 32px;
  height: 32px;
  border-radius: 50%;
  background: #e0e0e0;
  color: #999;
  display: flex;
  align-items: center;
  justify-content: center;
  font-weight: bold;
  font-size: 14px;
  position: relative;
}

.progress-step.active {
  background: #ff6b35;
  color: #fff;
}

.progress-step.complete {
  background: #4caf50;
  color: #fff;
}

.progress-line {
  flex: 1;
  height: 3px;
  background: #e0e0e0;
  margin: 0 8px;
}

.progress-line.complete {
  background: #4caf50;
}

.card {
  display: none;
  background: #fff;
  padding: 30px 20px;
  box-shadow: 0 2px 8px rgba(0,0,0,0.1);
}

.card.active {
  display: block;
}

.footer {
  background: #fff;
  padding: 15px 20px;
  border-radius: 0 0 12px 12px;
  box-shadow: 0 2px 8px rgba(0,0,0,0.1);
  display: flex;
  gap: 10px;
}

h2 {
  margin: 0 0 20px 0;
  color: #333;
  font-size: 20px;
}

.form-group {
  margin-bottom: 16px;
}

label {
  display: block;
  margin-bottom: 6px;
  color: #555;
  font-weight: 500;
  font-size: 14px;
}

label.required::after {
  content: " *";
  color: #ff6b35;
}

input[type="text"],
input[type="number"],
input[type="tel"],
input[type="email"] {
  width: 100%;
  padding: 12px;
  font-size: 16px;
  border-radius: 8px;
  border: 2px solid #ddd;
  transition: border-color 0.3s;
}

input:focus {
  outline: none;
  border-color: #ff6b35;
}

input.error {
  border-color: #f44336;
}

.error-message {
  color: #f44336;
  font-size: 13px;
  margin-top: 4px;
  display: none;
}

.error-message.show {
  display: block;
}

button {
  padding: 14px 20px;
  font-size: 16px;
  font-weight: 600;
  border: none;
  border-radius: 8px;
  cursor: pointer;
  transition: all 0.3s;
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 8px;
}

.btn-primary {
  background: #ff6b35;
  color: #fff;
  flex: 1;
}

.btn-primary:hover {
  background: #e65a2b;
}

.btn-primary:disabled {
  background: #ccc;
  cursor: not-allowed;
}

.btn-secondary {
  background: #6c757d;
  color: #fff;
}

.btn-secondary:hover {
  background: #5a6268;
}

.btn-scan {
  background: #2196f3;
  color: #fff;
  width: 100%;
}

.btn-scan:hover {
  background: #1976d2;
}

.btn-scan:disabled {
  background: #ccc;
  cursor: not-allowed;
}

.btn-restart {
  background: #6c757d;
  color: #fff;
}

.btn-restart:hover {
  background: #5a6268;
}

video {
  width: 100%;
  margin-top: 12px;
  border-radius: 8px;
  border: 2px solid #ddd;
  display: none;
}

video.active {
  display: block;
}

.info-box {
  background: #fff3e0;
  border-left: 4px solid #ff9800;
  padding: 12px;
  margin-bottom: 16px;
  border-radius: 4px;
  font-size: 14px;
  color: #666;
}

.total-display {
  background: #f5f5f5;
  padding: 16px;
  border-radius: 8px;
  margin: 16px 0;
  text-align: center;
}

.total-display .label {
  font-size: 14px;
  color: #666;
  margin-bottom: 4px;
}

.total-display .amount {
  font-size: 32px;
  font-weight: bold;
  color: #ff6b35;
}

.summary-table {
  width: 100%;
  margin-top: 16px;
  border-collapse: collapse;
}

.summary-table td {
  padding: 8px 0;
  border-bottom: 1px solid #eee;
}

.summary-table td:first-child {
  color: #666;
  font-size: 14px;
}

.summary-table td:last-child {
  text-align: right;
  font-weight: 500;
  color: #333;
}

.checkbox-group {
  background: #fffde7;
  border: 2px solid #fbc02d;
  padding: 16px;
  border-radius: 8px;
  margin: 16px 0;
}

.checkbox-label {
  display: flex;
  align-items: flex-start;
  gap: 12px;
  cursor: pointer;
}

.checkbox-label input[type="checkbox"] {
  width: 20px;
  height: 20px;
  margin-top: 2px;
  cursor: pointer;
}

.checkbox-label span {
  flex: 1;
  font-size: 14px;
  color: #333;
  line-height: 1.5;
}

.loading-overlay {
  position: fixed;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background: rgba(0,0,0,0.7);
  display: none;
  align-items: center;
  justify-content: center;
  z-index: 1000;
  flex-direction: column;
}

.loading-overlay.show {
  display: flex;
}

.spinner {
  width: 50px;
  height: 50px;
  border: 5px solid #f3f3f3;
  border-top: 5px solid #ff6b35;
  border-radius: 50%;
  animation: spin 1s linear infinite;
}

.loading-text {
  color: #fff;
  margin-top: 15px;
  font-size: 14px;
}

@keyframes spin {
  0% { transform: rotate(0deg); }
  100% { transform: rotate(360deg); }
}

.success-message {
  background: #4caf50;
  color: #fff;
  padding: 16px;
  border-radius: 8px;
  text-align: center;
  margin-bottom: 16px;
  display: none;
}

.success-message.show {
  display: block;
}

.alert-box {
  background: #f44336;
  color: #fff;
  padding: 12px;
  border-radius: 8px;
  margin-bottom: 16px;
  font-size: 14px;
  display: none;
}

.alert-box.show {
  display: block;
}

@media (max-width: 480px) {
  body {
    padding: 10px;
  }
  
  .card {
    padding: 20px 16px;
  }
}
</style>
</head>

<body>

<div class="container">
  <!-- Header -->
  <div class="header">
    <h1>üèçÔ∏è Motocross Track</h1>
    <div class="subtitle">Entry Registration System</div>
    
    <!-- Progress Indicator -->
    <div class="progress">
      <div class="progress-step active" id="step1">1</div>
      <div class="progress-line" id="line1"></div>
      <div class="progress-step" id="step2">2</div>
      <div class="progress-line" id="line2"></div>
      <div class="progress-step" id="step3">3</div>
    </div>
  </div>

  <!-- CARD 1: Scan & Motorcycles -->
  <div class="card active" id="card1">
    <h2>Step 1: Vehicle Registration</h2>

    <div class="alert-box" id="alertBox"></div>

    <div class="info-box">
      üì± <strong>Tip:</strong> Use Safari on iPhone. If scanning fails, enter registration manually below.
    </div>

    <button type="button" class="btn-scan" id="scanButton">
      üì∑ Scan License Disc Barcode
    </button>
    
    <video id="video" playsinline></video>
    <button type="button" class="btn-secondary" id="stopScanButton" style="display:none; width:100%; margin-top:8px;">
      ‚úï Stop Camera
    </button>

    <div class="form-group">
      <label for="vehicleReg" class="required">Vehicle Registration</label>
      <input type="text" id="vehicleReg" placeholder="e.g., CA 123456" maxlength="20">
      <div class="error-message" id="vehicleRegError">Please enter vehicle registration</div>
    </div>

    <div class="form-group">
      <label for="motorcycles" class="required">Number of Motorcycles</label>
      <input type="number" id="motorcycles" placeholder="1" min="1" max="50" value="1">
      <div class="error-message" id="motorcyclesError">Please enter number of motorcycles</div>
    </div>

    <div class="total-display">
      <div class="label">Entry Fee (R150 per motorcycle)</div>
      <div class="amount">R<span id="total">150</span></div>
    </div>
  </div>

  <!-- CARD 2: Customer Info -->
  <div class="card" id="card2">
    <h2>Step 2: Client Details</h2>

    <div class="total-display">
      <div class="label">Amount Due</div>
      <div class="amount">R<span id="total2">150</span></div>
    </div>

    <div class="form-group">
      <label for="name" class="required">First Name</label>
      <input type="text" id="name" placeholder="John">
      <div class="error-message" id="nameError">Please enter first name</div>
    </div>

    <div class="form-group">
      <label for="surname" class="required">Surname</label>
      <input type="text" id="surname" placeholder="Smith">
      <div class="error-message" id="surnameError">Please enter surname</div>
    </div>

    <div class="form-group">
      <label for="phone" class="required">Telephone Number</label>
      <input type="tel" id="phone" placeholder="0821234567">
      <div class="error-message" id="phoneError">Please enter valid phone number</div>
    </div>

    <div class="form-group">
      <label for="email">Email Address (Optional)</label>
      <input type="email" id="email" placeholder="email@example.com">
      <div class="error-message" id="emailError">Please enter valid email address</div>
      <div style="font-size:12px; color:#666; margin-top:4px;">
        üìß Provide email to receive a receipt copy
      </div>
    </div>
  </div>

  <!-- CARD 3: Payment Confirmation -->
  <div class="card" id="card3">
    <h2>Step 3: Confirm Payment</h2>

    <div class="success-message" id="successMessage">
      ‚úì Transaction completed successfully! Receipt sent.
    </div>

    <table class="summary-table">
      <tr>
        <td>Vehicle Registration:</td>
        <td id="summaryVehicleReg">-</td>
      </tr>
      <tr>
        <td>Client Name:</td>
        <td id="summaryName">-</td>
      </tr>
      <tr>
        <td>Phone Number:</td>
        <td id="summaryPhone">-</td>
      </tr>
      <tr>
        <td>Email Address:</td>
        <td id="summaryEmail">Not provided</td>
      </tr>
      <tr>
        <td>Number of Motorcycles:</td>
        <td id="summaryMotorcycles">-</td>
      </tr>
      <tr style="font-weight:bold; font-size:16px;">
        <td style="color:#ff6b35;">Total Amount:</td>
        <td style="color:#ff6b35;">R<span id="summaryTotal">-</span></td>
      </tr>
    </table>

    <div class="checkbox-group">
      <label class="checkbox-label">
        <input type="checkbox" id="paid">
        <span><strong>I confirm that payment of R<span id="confirmTotal">0</span> has been received from the client</strong></span>
      </label>
    </div>

    <button type="button" class="btn-primary" id="completeButton" style="width:100%;">
      ‚úì Complete Transaction
    </button>
  </div>

  <!-- Footer Navigation -->
  <div class="footer">
    <button type="button" class="btn-restart" id="restartButton">
      ‚Üª Restart
    </button>
    <button type="button" class="btn-primary" id="nextButton">
      Next ‚Üí
    </button>
  </div>
</div>

<!-- Loading Overlay -->
<div class="loading-overlay" id="loadingOverlay">
  <div class="spinner"></div>
  <div class="loading-text">Processing...</div>
</div>

<script>
/* ======================
   CONFIG
====================== */
const PRICE_PER_MOTORCYCLE = 150;
const SERVICE_ID = "service_b3o7uon";
const TEMPLATE_ID = "template_se4lmxj";
const TRACK_EMAIL = "erora@ybox.co.za";

/* ======================
   GLOBAL VARIABLES
====================== */
var currentCard = 1;
var codeReader = null;
var scanning = false;
var videoStream = null;
var latitude = "";
var longitude = "";

/* ======================
   INITIALIZE EMAILJS
====================== */
window.addEventListener('load', function() {
  try {
    if (typeof emailjs !== 'undefined') {
      emailjs.init("1fovTEqPOuwgcomem");
      console.log('‚úì EmailJS initialized');
    } else {
      console.error('EmailJS library not loaded');
    }
  } catch (err) {
    console.error('EmailJS init error:', err);
  }
  
  if (typeof ZXing !== 'undefined') {
    console.log('‚úì ZXing loaded');
  } else {
    console.error('ZXing library not loaded');
    document.getElementById('scanButton').disabled = true;
  }
});

/* ======================
   GET GEOLOCATION
====================== */
if (navigator.geolocation) {
  navigator.geolocation.getCurrentPosition(
    function(pos) {
      latitude = pos.coords.latitude.toFixed(6);
      longitude = pos.coords.longitude.toFixed(6);
      console.log('Location obtained');
    },
    function(err) {
      console.log("Geolocation error:", err);
    }
  );
}

/* ======================
   CALCULATE TOTAL
====================== */
document.getElementById("motorcycles").addEventListener("input", function(e) {
  var qty = parseInt(e.target.value) || 0;
  var total = qty * PRICE_PER_MOTORCYCLE;
  document.getElementById("total").innerText = total;
});

/* ======================
   START SCAN
====================== */
document.getElementById("scanButton").addEventListener("click", async function() {
  if (scanning) return;
  
  if (typeof ZXing === 'undefined') {
    alert('Barcode scanner not available. Please enter vehicle registration manually.');
    return;
  }

  var video = document.getElementById("video");
  var scanButton = document.getElementById("scanButton");
  var stopButton = document.getElementById("stopScanButton");

  try {
    videoStream = await navigator.mediaDevices.getUserMedia({
      video: { facingMode: "environment" }
    });

    video.srcObject = videoStream;
    video.classList.add("active");
    await video.play();

    scanning = true;
    scanButton.style.display = "none";
    stopButton.style.display = "block";

    codeReader = new ZXing.BrowserPDF417Reader();

    codeReader.decodeFromVideoElement(video)
      .then(function(result) {
        handleScan(result.text);
      })
      .catch(function(err) {
        console.error("Scan error:", err);
        alert("Scanning failed. Please enter Vehicle Registration manually.");
        stopScan();
      });

  } catch (err) {
    console.error("Camera access failed:", err);
    alert("Camera access denied. Please enter Vehicle Registration manually.");
    stopScan();
  }
});

/* ======================
   STOP SCAN
====================== */
document.getElementById("stopScanButton").addEventListener("click", stopScan);

function stopScan() {
  var video = document.getElementById("video");
  var scanButton = document.getElementById("scanButton");
  var stopButton = document.getElementById("stopScanButton");

  if (videoStream) {
    videoStream.getTracks().forEach(function(track) {
      track.stop();
    });
    videoStream = null;
  }

  if (codeReader) {
    try {
      codeReader.reset();
    } catch (e) {
      console.log('Error resetting codeReader:', e);
    }
  }

  video.classList.remove("active");
  video.srcObject = null;
  scanning = false;
  scanButton.style.display = "block";
  stopButton.style.display = "none";
}

/* ======================
   HANDLE SCAN RESULT
====================== */
function handleScan(text) {
  console.log("Scanned data:", text);
  
  var parts = text.split("%");
  var vehicleReg = "";
  
  if (parts.length >= 7) {
    vehicleReg = parts[6].trim();
  } else if (parts.length >= 1) {
    for (var i = 0; i < parts.length; i++) {
      if (parts[i].trim().length > 0) {
        vehicleReg = parts[i].trim();
        break;
      }
    }
  }
  
  if (vehicleReg) {
    document.getElementById("vehicleReg").value = vehicleReg;
    alert("‚úì Vehicle registration scanned: " + vehicleReg);
  } else {
    alert("Could not extract registration. Please enter manually.");
  }
  
  stopScan();
}

/* ======================
   VALIDATION
====================== */
function validateCard1() {
  var valid = true;
  
  var vehicleReg = document.getElementById("vehicleReg").value.trim();
  var motorcycles = parseInt(document.getElementById("motorcycles").value);
  
  if (!vehicleReg) {
    document.getElementById("vehicleReg").classList.add("error");
    document.getElementById("vehicleRegError").classList.add("show");
    valid = false;
  } else {
    document.getElementById("vehicleReg").classList.remove("error");
    document.getElementById("vehicleRegError").classList.remove("show");
  }
  
  if (!motorcycles || motorcycles < 1) {
    document.getElementById("motorcycles").classList.add("error");
    document.getElementById("motorcyclesError").classList.add("show");
    valid = false;
  } else {
    document.getElementById("motorcycles").classList.remove("error");
    document.getElementById("motorcyclesError").classList.remove("show");
  }
  
  return valid;
}

function validateCard2() {
  var valid = true;
  
  var name = document.getElementById("name").value.trim();
  var surname = document.getElementById("surname").value.trim();
  var phone = document.getElementById("phone").value.trim();
  var email = document.getElementById("email").value.trim();
  
  if (!name) {
    document.getElementById("name").classList.add("error");
    document.getElementById("nameError").classList.add("show");
    valid = false;
  } else {
    document.getElementById("name").classList.remove("error");
    document.getElementById("nameError").classList.remove("show");
  }
  
  if (!surname) {
    document.getElementById("surname").classList.add("error");
    document.getElementById("surnameError").classList.add("show");
    valid = false;
  } else {
    document.getElementById("surname").classList.remove("error");
    document.getElementById("surnameError").classList.remove("show");
  }
  
  var phoneRegex = /^0\d{9}$/;
  if (!phone || !phoneRegex.test(phone.replace(/\s/g, ''))) {
    document.getElementById("phone").classList.add("error");
    document.getElementById("phoneError").classList.add("show");
    valid = false;
  } else {
    document.getElementById("phone").classList.remove("error");
    document.getElementById("phoneError").classList.remove("show");
  }
  
  if (email) {
    var emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
    if (!emailRegex.test(email)) {
      document.getElementById("email").classList.add("error");
      document.getElementById("emailError").classList.add("show");
      valid = false;
    } else {
      document.getElementById("email").classList.remove("error");
      document.getElementById("emailError").classList.remove("show");
    }
  } else {
    document.getElementById("email").classList.remove("error");
    document.getElementById("emailError").classList.remove("show");
  }
  
  return valid;
}

/* ======================
   NEXT CARD
====================== */
document.getElementById("nextButton").addEventListener("click", function() {
  console.log('Next button clicked, current card:', currentCard);
  
  if (currentCard === 1 && !validateCard1()) {
    console.log('Card 1 validation failed');
    return;
  }
  
  if (currentCard === 2 && !validateCard2()) {
    console.log('Card 2 validation failed');
    return;
  }
  
  if (scanning) {
    stopScan();
  }
  
  currentCard++;
  console.log('Moving to card:', currentCard);
  
  var cards = document.querySelectorAll(".card");
  for (var i = 0; i < cards.length; i++) {
    cards[i].classList.remove("active");
  }
  
  document.getElementById("card" + currentCard).classList.add("active");
  
  updateProgress();
  
  if (currentCard === 3) {
    document.getElementById("nextButton").style.display = "none";
    populateSummary();
  }
  
  if (currentCard === 2) {
    document.getElementById("total2").innerText = document.getElementById("total").innerText;
  }
});

/* ======================
   UPDATE PROGRESS
====================== */
function updateProgress() {
  for (var i = 1; i <= 3; i++) {
    var step = document.getElementById("step" + i);
    if (i < currentCard) {
      step.classList.add("complete");
      step.classList.remove("active");
    } else if (i === currentCard) {
      step.classList.add("active");
      step.classList.remove("complete");
    } else {
      step.classList.remove("active", "complete");
    }
  }
  
  for (var i = 1; i <= 2; i++) {
    var line = document.getElementById("line" + i);
    if (i < currentCard) {
      line.classList.add("complete");
    } else {
      line.classList.remove("complete");
    }
  }
}

/* ======================
   POPULATE SUMMARY
====================== */
function populateSummary() {
  var total = document.getElementById("total").innerText;
  
  document.getElementById("summaryVehicleReg").innerText = document.getElementById("vehicleReg").value;
  document.getElementById("summaryName").innerText = 
    document.getElementById("name").value + " " + document.getElementById("surname").value;
  document.getElementById("summaryPhone").innerText = document.getElementById("phone").value;
  
  var email = document.getElementById("email").value.trim();
  document.getElementById("summaryEmail").innerText = email || "Not provided";
  
  document.getElementById("summaryMotorcycles").innerText = document.getElementById("motorcycles").value;
  document.getElementById("summaryTotal").innerText = total;
  document.getElementById("confirmTotal").innerText = total;
}

/* ======================
   RESTART FORM
====================== */
document.getElementById("restartButton").addEventListener("click", function() {
  if (!confirm("Are you sure you want to restart? All entered data will be lost.")) {
    return;
  }
  
  stopScan();
  
  document.getElementById("vehicleReg").value = "";
  document.getElementById("motorcycles").value = "1";
  document.getElementById("name").value = "";
  document.getElementById("surname").value = "";
  document.getElementById("phone").value = "";
  document.getElementById("email").value = "";
  document.getElementById("paid").checked = false;
  
  document.getElementById("total").innerText = PRICE_PER_MOTORCYCLE;
  
  var errors = document.querySelectorAll(".error");
  for (var i = 0; i < errors.length; i++) {
    errors[i].classList.remove("error");
  }
  
  var errorMessages = document.querySelectorAll(".error-message");
  for (var i = 0; i < errorMessages.length; i++) {
    errorMessages[i].classList.remove("show");
  }
  
  document.getElementById("successMessage").classList.remove("show");
  
  currentCard = 1;
  
  var cards = document.querySelectorAll(".card");
  for (var i = 0; i < cards.length; i++) {
    cards[i].classList.remove("active");
  }
  document.getElementById("card1").classList.add("active");
  document.getElementById("nextButton").style.display = "block";
  
  updateProgress();
});

/* ======================
   COMPLETE
====================== */
document.getElementById("completeButton").addEventListener("click", async function() {
  if (!document.getElementById("paid").checked) {
    alert("‚ö†Ô∏è Please confirm that payment has been received before completing.");
    return;
  }
  
  var loadingOverlay = document.getElementById("loadingOverlay");
  var completeButton = document.getElementById("completeButton");
  
  try {
    loadingOverlay.classList.add("show");
    completeButton.disabled = true;
    
    var receiptNumber = "MX" + Date.now();
    var dateTime = new Date().toLocaleString("en-ZA", {
      year: 'numeric',
      month: '2-digit',
      day: '2-digit',
      hour: '2-digit',
      minute: '2-digit',
      second: '2-digit',
      hour12: false
    });
    
    var emailData = {
      receipt_number: receiptNumber,
      vehicle_reg: document.getElementById("vehicleReg").value,
      motorcycles: document.getElementById("motorcycles").value,
      total: document.getElementById("total").innerText,
      name: document.getElementById("name").value,
      surname: document.getElementById("surname").value,
      phone: document.getElementById("phone").value,
      email: document.getElementById("email").value.trim() || "Not provided",
      lat: latitude || "Not available",
      lng: longitude || "Not available",
      date: dateTime
    };
    
    await emailjs.send(SERVICE_ID, TEMPLATE_ID, {
      ...emailData,
      to_email: TRACK_EMAIL
    });
    
    var clientEmail = document.getElementById("email").value.trim();
    if (clientEmail) {
      await emailjs.send(SERVICE_ID, TEMPLATE_ID, {
        ...emailData,
        to_email: clientEmail
      });
    }
    
    loadingOverlay.classList.remove("show");
    completeButton.disabled = false;
    
    document.getElementById("successMessage").classList.add("show");
    
    setTimeout(function() {
      document.getElementById("restartButton").click();
    }, 3000);
    
  } catch (err) {
    console.error("Email error:", err);
    loadingOverlay.classList.remove("show");
    completeButton.disabled = false;
    
    var errorMsg = err.text || err.message || "Unknown error";
    alert("‚ùå Error sending receipt: " + errorMsg);
  }
});
</script>

</body>
</html>
